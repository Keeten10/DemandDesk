{% extends "base.html" %}

{% block title %}编辑需求 - {{ requirement.code }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <!-- 页面标题 -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-edit"></i> 编辑需求
                    <small class="text-muted">{{ requirement.code }}</small>
                </h2>
                <div class="btn-group">
                    <a href="{{ url_for('requirement.view', id=requirement.id) }}" class="btn btn-outline-info">
                        <i class="fas fa-eye"></i> 查看
                    </a>
                    <a href="{{ url_for('requirement.index') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> 返回列表
                    </a>
                    <button type="button" class="btn btn-primary" onclick="submitFormFromTop()">
                        <i class="fas fa-save"></i> 保存更改
                    </button>
                </div>
            </div>

            <!-- 编辑提示 -->
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle"></i>
                您正在编辑需求 <strong>{{ requirement.title }}</strong>，
                上次更新时间：{{ requirement.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- 表单内容与create.html相同，但数据已填充 -->
            <form method="POST" enctype="multipart/form-data" id="requirementForm">
                {{ form.hidden_tag() }}
                
                <!-- 内容结构与create.html相同 -->
                <div class="row">
                    <!-- 左侧主要内容 -->
                    <div class="col-md-8">
                        <!-- 基本信息 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">基本信息</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">需求编号</label>
                                        <input class="form-control" type="text" value="{{ requirement.code }}" readonly>
                                        <small class="text-muted">需求编号不可修改</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ form.version.label(class="form-label") }}
                                        {{ form.version(class="form-control", placeholder="如: v1.0.0") }}
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.title.label(class="form-label required") }}
                                    {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else ""), 
                                                 placeholder="简洁明确的需求标题") }}
                                    {% if form.title.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.title.errors[0] }}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.description.label(class="form-label required") }}
                                    {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), 
                                                      rows="5", 
                                                      placeholder="详细描述需求内容...") }}
                                    {% if form.description.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.description.errors[0] }}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        {{ form.type.label(class="form-label required") }}
                                        {{ form.type(class="form-select") }}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        {{ form.priority.label(class="form-label required") }}
                                        {{ form.priority(class="form-select") }}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        {{ form.status.label(class="form-label") }}
                                        {{ form.status(class="form-select") }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 详细描述 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">详细描述</h5>
                                <small class="text-muted">完整的需求描述有助于准确理解和实现需求</small>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    {{ form.background.label(class="form-label") }}
                                    {{ form.background(class="form-control", rows="3", 
                                                      placeholder="说明需求的背景和产生原因...") }}
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.objective.label(class="form-label") }}
                                    {{ form.objective(class="form-control", rows="3", 
                                                     placeholder="明确需求要达到的目标...") }}
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.scope.label(class="form-label") }}
                                    {{ form.scope(class="form-control", rows="3", 
                                                 placeholder="定义需求的范围边界...") }}
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.acceptance_criteria.label(class="form-label") }}
                                    {{ form.acceptance_criteria(class="form-control", rows="4", 
                                                               placeholder="列出需求的验收标准...\n1. \n2. \n3. ") }}
                                </div>
                            </div>
                        </div>

                        <!-- 约束和风险 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">约束和风险</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    {{ form.assumptions.label(class="form-label") }}
                                    {{ form.assumptions(class="form-control", rows="3", 
                                                       placeholder="列出需求实现的前提假设...") }}
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.constraints.label(class="form-label") }}
                                    {{ form.constraints(class="form-control", rows="3", 
                                                       placeholder="技术、资源、时间等约束条件...") }}
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.risks.label(class="form-label") }}
                                    {{ form.risks(class="form-control", rows="3", 
                                                 placeholder="可能的风险及应对措施...") }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧配置信息 -->
                    <div class="col-md-4">
                        <!-- 归属信息 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">归属信息</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    {{ form.project_id.label(class="form-label") }}
                                    {{ form.project_id(class="form-select") }}
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.module_id.label(class="form-label") }}
                                    {{ form.module_id(class="form-select") }}
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.category_id.label(class="form-label") }}
                                    {{ form.category_id(class="form-select") }}
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.source.label(class="form-label") }}
                                    {{ form.source(class="form-control", placeholder="如：客户反馈、产品规划等") }}
                                </div>
                            </div>
                        </div>

                        <!-- 人员分配 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">人员分配</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    {{ form.assignee_id.label(class="form-label") }}
                                    {{ form.assignee_id(class="form-select") }}
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.reviewer_id.label(class="form-label") }}
                                    {{ form.reviewer_id(class="form-select") }}
                                </div>
                            </div>
                        </div>

                        <!-- 时间和估算 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">时间和估算</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    {{ form.start_date.label(class="form-label") }}
                                    {{ form.start_date(class="form-control") }}
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.due_date.label(class="form-label") }}
                                    {{ form.due_date(class="form-control") }}
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.estimated_hours.label(class="form-label") }}
                                    <div class="input-group">
                                        {{ form.estimated_hours(class="form-control", placeholder="0") }}
                                        <span class="input-group-text">小时</span>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.story_points.label(class="form-label") }}
                                    {{ form.story_points(class="form-control", placeholder="1-100") }}
                                    <small class="text-muted">用于敏捷开发的工作量估算</small>
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.business_value.label(class="form-label") }}
                                    <div class="input-group">
                                        {{ form.business_value(class="form-control", placeholder="1-100") }}
                                        <span class="input-group-text">分</span>
                                    </div>
                                    <small class="text-muted">业务价值评分，用于优先级排序</small>
                                </div>
                            </div>
                        </div>

                        <!-- 标签和关联 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">标签和关联</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    {{ form.tags.label(class="form-label") }}
                                    {{ form.tags(class="form-select", multiple=True, size=4) }}
                                    <small class="text-muted">按住Ctrl键可多选</small>
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.dependencies.label(class="form-label") }}
                                    {{ form.dependencies(class="form-select", multiple=True, size=4) }}
                                    <small class="text-muted">选择本需求依赖的其他需求</small>
                                </div>
                            </div>
                        </div>

                        <!-- 附件 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">附件管理</h5>
                            </div>
                            <div class="card-body">
                                <!-- 现有附件列表 -->
                                {% if requirement.attachments %}
                                <div class="mb-3">
                                    <h6>已上传的附件 <span class="badge bg-info">{{ requirement.attachments|length }}</span></h6>
                                    <div class="attachment-list">
                                        {% for attachment in requirement.attachments %}
                                        <div class="attachment-item border rounded p-2 mb-2 d-flex justify-content-between align-items-center" 
                                             data-attachment-id="{{ attachment.id }}">
                                            <div class="attachment-info d-flex align-items-center">
                                                <i class="fas fa-{{ 'file-pdf' if attachment.filename.lower().endswith('.pdf') 
                                                                 else 'file-word' if attachment.filename.lower().endswith(('.doc', '.docx'))
                                                                 else 'file-excel' if attachment.filename.lower().endswith(('.xls', '.xlsx'))
                                                                 else 'file-image' if attachment.filename.lower().endswith(('.png', '.jpg', '.jpeg', '.gif'))
                                                                 else 'file' }} text-primary me-2"></i>
                                                <div>
                                                    <a href="{{ url_for('requirement.download_attachment', id=attachment.id) }}" 
                                                       class="text-decoration-none fw-bold">
                                                        {{ attachment.filename }}
                                                    </a>
                                                    <br>
                                                    <small class="text-muted">
                                                        {{ (attachment.file_size / 1024)|round(1) }}KB • 
                                                        {{ attachment.uploaded_at.strftime('%Y-%m-%d %H:%M') }} • 
                                                        {{ attachment.uploader.full_name if attachment.uploader else '未知' }}
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="attachment-actions">
                                                <a href="{{ url_for('requirement.download_attachment', id=attachment.id) }}" 
                                                   class="btn btn-sm btn-outline-primary me-1" title="下载">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="removeAttachment({{ attachment.id }})" title="删除">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <hr>
                                {% endif %}
                                
                                <!-- 上传新附件 -->
                                <div class="upload-section">
                                    <h6>上传新附件</h6>
                                    <div class="mb-3">
                                        {{ form.attachments.label(class="form-label") }}
                                        {{ form.attachments(class="form-control", id="attachment-input") }}
                                        <div class="form-text">
                                            支持的格式：PDF, Word (.doc/.docx), Excel (.xls/.xlsx), 图片 (.png/.jpg/.jpeg/.gif), 文本文件 (.txt)<br>
                                            最大文件大小：16MB
                                        </div>
                                    </div>
                                    
                                    <!-- 快速上传按钮 -->
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-outline-success btn-sm" 
                                                onclick="uploadAttachmentNow()">
                                            <i class="fas fa-upload"></i> 立即上传
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm" 
                                                onclick="previewSelectedFile()">
                                            <i class="fas fa-eye"></i> 预览选择
                                        </button>
                                    </div>
                                    
                                    <!-- 上传进度条 -->
                                    <div id="upload-progress" class="mt-2" style="display: none;">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                 role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted">正在上传...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 编辑历史 -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">最近修改记录</h5>
                            </div>
                            <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                {% if recent_history %}
                                <ul class="list-unstyled mb-0">
                                    {% for h in recent_history %}
                                    <li class="mb-2">
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i> {{ h.created_at.strftime('%m-%d %H:%M') }}
                                        </small><br>
                                        <small>
                                            {{ h.user.full_name if h.user else '系统' }} 
                                            {% if h.field_name %}
                                            修改了 <strong>{{ h.field_name }}</strong>
                                            {% else %}
                                            {{ h.action }}
                                            {% endif %}
                                            {% if h.comment %}
                                            <br><em class="text-muted">{{ h.comment }}</em>
                                            {% endif %}
                                        </small>
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <p class="text-muted mb-0">暂无修改记录</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <button type="button" class="btn btn-outline-info" onclick="showChanges()">
                                            <i class="fas fa-exchange-alt"></i> 查看变更
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" onclick="restoreVersion()">
                                            <i class="fas fa-history"></i> 恢复版本
                                        </button>
                                    </div>
                                    <div>
                                        <a href="{{ url_for('requirement.view', id=requirement.id) }}" class="btn btn-secondary">
                                            <i class="fas fa-times"></i> 取消
                                        </a>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> 保存更改
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.form-label.required::after {
    content: " *";
    color: red;
}

.attachment-item {
    transition: all 0.3s ease;
    background-color: #f8f9fa;
}

.attachment-item:hover {
    background-color: #e9ecef;
    border-color: #dee2e6 !important;
}

.attachment-item.removing {
    opacity: 0.5;
    background-color: #ffebee;
}

.attachment-info i {
    font-size: 1.2em;
}

.attachment-actions .btn {
    border: none;
    padding: 0.25rem 0.5rem;
}

.upload-section {
    border-top: 1px solid #dee2e6;
    padding-top: 1rem;
}

#upload-progress .progress {
    height: 8px;
}

.change-indicator {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 10px;
    height: 10px;
    background-color: #ffc107;
    border-radius: 50%;
    display: none;
}

.field-changed .change-indicator {
    display: block;
}

.field-changed {
    position: relative;
}

.field-changed::after {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    width: 8px;
    height: 8px;
    background-color: #ffc107;
    border-radius: 50%;
    z-index: 1;
}
</style>

<script>
// 从顶部提交表单
function submitFormFromTop() {
    const form = document.getElementById('requirementForm');
    // 验证必填字段
    const requiredFields = form.querySelectorAll('[required], .required input, .required textarea, .required select');
    let hasEmptyRequired = false;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            hasEmptyRequired = true;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (hasEmptyRequired) {
        alert('请填写所有必填字段');
        // 滚动到第一个错误字段
        const firstError = form.querySelector('.is-invalid');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstError.focus();
        }
        return;
    }
    
    // 标记表单正在提交
    isFormSubmitting = true;
    form.submit();
}

// 记录初始表单值
let initialFormData = {};

// 页面加载时保存初始值
document.addEventListener('DOMContentLoaded', function() {
    saveInitialFormData();
    setupChangeDetection();
    enableAutoSave();
});

// 保存初始表单数据
function saveInitialFormData() {
    const form = document.getElementById('requirementForm');
    const inputs = form.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        if (input.type === 'checkbox') {
            initialFormData[input.name] = input.checked;
        } else if (input.type === 'radio') {
            if (input.checked) {
                initialFormData[input.name] = input.value;
            }
        } else {
            initialFormData[input.name] = input.value;
        }
    });
}

// 设置变更检测
function setupChangeDetection() {
    const form = document.getElementById('requirementForm');
    const inputs = form.querySelectorAll('input, textarea, select');
    
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            checkFieldChange(this);
        });
        input.addEventListener('change', function() {
            checkFieldChange(this);
        });
    });
}

function checkFieldChange(field) {
    let currentValue = field.value;
    if (field.type === 'checkbox') {
        currentValue = field.checked;
    }
    
    const initialValue = initialFormData[field.name];
    const fieldContainer = field.closest('.mb-3');
    
    if (currentValue !== initialValue) {
        fieldContainer.classList.add('field-changed');
    } else {
        fieldContainer.classList.remove('field-changed');
    }
}

// 删除附件
function removeAttachment(attachmentId) {
    if (confirm('确定要删除这个附件吗？删除后无法恢复。')) {
        const attachmentItem = document.querySelector(`[data-attachment-id="${attachmentId}"]`);
        if (attachmentItem) {
            attachmentItem.classList.add('removing');
        }
        
        // 发送AJAX请求删除附件
        fetch(`/requirements/attachments/${attachmentId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf_token]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 从界面中移除附件项
                if (attachmentItem) {
                    attachmentItem.style.transition = 'opacity 0.3s ease';
                    attachmentItem.style.opacity = '0';
                    setTimeout(() => {
                        attachmentItem.remove();
                        updateAttachmentCount();
                    }, 300);
                }
                showNotification('附件删除成功', 'success');
            } else {
                if (attachmentItem) {
                    attachmentItem.classList.remove('removing');
                }
                showNotification('删除失败：' + (data.message || '未知错误'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (attachmentItem) {
                attachmentItem.classList.remove('removing');
            }
            showNotification('删除失败：网络错误', 'danger');
        });
    }
}

// 立即上传附件
function uploadAttachmentNow() {
    const fileInput = document.getElementById('attachment-input');
    const file = fileInput.files[0];
    
    if (!file) {
        showNotification('请先选择要上传的文件', 'warning');
        return;
    }
    
    // 检查文件大小
    const maxSize = 16 * 1024 * 1024; // 16MB
    if (file.size > maxSize) {
        showNotification('文件大小超过限制（16MB）', 'danger');
        return;
    }
    
    // 检查文件类型
    const allowedTypes = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'png', 'jpg', 'jpeg', 'gif', 'txt'];
    const fileExtension = file.name.split('.').pop().toLowerCase();
    if (!allowedTypes.includes(fileExtension)) {
        showNotification('不支持的文件类型', 'danger');
        return;
    }
    
    // 显示进度条
    const progressDiv = document.getElementById('upload-progress');
    const progressBar = progressDiv.querySelector('.progress-bar');
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    
    // 创建 FormData
    const formData = new FormData();
    formData.append('file', file);
    formData.append('csrf_token', document.querySelector('[name=csrf_token]').value);
    
    // 发送上传请求
    const xhr = new XMLHttpRequest();
    
    // 上传进度
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressBar.style.width = percentComplete + '%';
        }
    });
    
    xhr.onload = function() {
        progressDiv.style.display = 'none';
        
        if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            if (response.success) {
                showNotification('文件上传成功', 'success');
                // 清空文件选择
                fileInput.value = '';
                // 刷新页面以显示新附件
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showNotification('上传失败：' + response.message, 'danger');
            }
        } else {
            showNotification('上传失败：服务器错误', 'danger');
        }
    };
    
    xhr.onerror = function() {
        progressDiv.style.display = 'none';
        showNotification('上传失败：网络错误', 'danger');
    };
    
    const requirementId = {{ requirement.id }};
    xhr.open('POST', `/requirements/${requirementId}/upload_attachment`);
    xhr.send(formData);
}

// 预览选择的文件
function previewSelectedFile() {
    const fileInput = document.getElementById('attachment-input');
    const file = fileInput.files[0];
    
    if (!file) {
        showNotification('请先选择文件', 'warning');
        return;
    }
    
    const fileInfo = `
        文件名：${file.name}
        文件大小：${(file.size / 1024).toFixed(1)} KB
        文件类型：${file.type || '未知'}
        最后修改：${new Date(file.lastModified).toLocaleString()}
    `;
    
    alert('文件信息：\n' + fileInfo);
}

// 更新附件数量显示
function updateAttachmentCount() {
    const attachmentItems = document.querySelectorAll('.attachment-item:not(.removing)');
    const countBadge = document.querySelector('.card-header .badge');
    if (countBadge) {
        countBadge.textContent = attachmentItems.length;
    }
}

// 显示变更对比
function showChanges() {
    const form = document.getElementById('requirementForm');
    const changedFields = form.querySelectorAll('.field-changed');
    
    if (changedFields.length === 0) {
        showNotification('没有检测到变更', 'info');
        return;
    }
    
    let changesList = '检测到以下字段发生变更：\n\n';
    changedFields.forEach((field, index) => {
        const label = field.querySelector('.form-label');
        if (label) {
            const labelText = label.textContent.trim().replace(' *', '');
            changesList += `${index + 1}. ${labelText}\n`;
        }
    });
    
    alert(changesList);
}

// 恢复历史版本
function restoreVersion() {
    if (confirm('恢复历史版本将会覆盖当前的修改，确定继续吗？')) {
        // TODO: 实现版本恢复逻辑
        showNotification('版本恢复功能In progress...', 'info');
    }
}

// 自动保存草稿
let autoSaveTimer;
function enableAutoSave() {
    autoSaveTimer = setInterval(() => {
        const form = document.getElementById('requirementForm');
        const changedFields = form.querySelectorAll('.field-changed');
        
        if (changedFields.length > 0) {
            console.log('检测到变更，准备自动保存...');
            // TODO: 实现自动保存逻辑
            // 可以通过AJAX发送表单数据到服务器
        }
    }, 60000); // 每60秒检查一次
}

// 显示通知
function showNotification(message, type = 'info') {
    // 移除现有通知
    const existingNotification = document.querySelector('.notification-toast');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // 创建通知元素
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed notification-toast`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
    notification.innerHTML = `
        <strong>${getTypeIcon(type)}</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // 添加到页面
    document.body.appendChild(notification);
    
    // 5秒后自动移除
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function getTypeIcon(type) {
    const icons = {
        'success': '✓',
        'danger': '✗',
        'warning': '⚠',
        'info': 'ℹ'
    };
    return icons[type] || 'ℹ';
}

// 离开页面时提醒
let isFormSubmitting = false;

window.addEventListener('beforeunload', function (e) {
    if (isFormSubmitting) {
        return; // 如果正在提交表单，不显示提醒
    }
    
    const form = document.getElementById('requirementForm');
    const changedFields = form.querySelectorAll('.field-changed');
    
    if (changedFields.length > 0) {
        e.preventDefault();
        e.returnValue = '您有未保存的更改，确定要离开吗？';
        return e.returnValue;
    }
});

// 表单提交时标记为正在提交
document.getElementById('requirementForm').addEventListener('submit', function() {
    isFormSubmitting = true;
});

// 页面可见性变化时清理定时器
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        if (autoSaveTimer) {
            clearInterval(autoSaveTimer);
        }
    } else {
        enableAutoSave();
    }
});
</script>
{% endblock %}
