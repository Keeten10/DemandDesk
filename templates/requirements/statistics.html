{% extends "base.html" %}

{% block title %}需求统计分析{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-chart-bar"></i> 需求统计分析</h2>
        <div>
            <select class="form-select" onchange="filterByProject(this.value)">
                <option value="">所有项目</option>
                {% for project in projects %}
                <option value="{{ project.id }}">{{ project.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- 关键指标卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ stats.total }}</h3>
                    <p class="text-muted mb-0">Total demand</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">{{ stats.completion_rate }}%</h3>
                    <p class="text-muted mb-0">完成率</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">{{ stats.status_stats.get('In progress', 0) }}</h3>
                    <p class="text-muted mb-0">In Progress</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-danger">{{ stats.overdue }}</h3>
                    <p class="text-muted mb-0">Overdue需求</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="row">
        <!-- 状态分布 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">需求状态分布</h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 优先级分布 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">优先级分布</h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="priorityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 类型分布 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">需求类型分布</h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 月度趋势 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">月度需求趋势</h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 300px;">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 项目需求分布 -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">项目需求分布</h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 200px;">
                        <canvas id="projectChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 团队工作量 -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">团队工作量统计</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>成员</th>
                                    <th>待处理</th>
                                    <th>In Progress</th>
                                    <th>Completed</th>
                                    <th>总计</th>
                                    <th>预估工时</th>
                                    <th>完成率</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for member in team_stats %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ member.avatar or '/static/default-avatar.png' }}" 
                                                 class="rounded-circle me-2" width="30" height="30">
                                            {{ member.name }}
                                        </div>
                                    </td>
                                    <td>{{ member.pending }}</td>
                                    <td>{{ member.in_progress }}</td>
                                    <td>{{ member.completed }}</td>
                                    <td><strong>{{ member.total }}</strong></td>
                                    <td>{{ member.estimated_hours }}h</td>
                                    <td>
                                        <div class="progress" style="width: 100px;">
                                            <div class="progress-bar" style="width: {{ member.completion_rate }}%">
                                                {{ member.completion_rate }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 引入Chart.js 本地文件 -->
<script src="{{ url_for('static', filename='js/chart.js') }}"></script>
<script>
// 图表数据
const chartsData = {{ charts_data | tojson }};

// 数据完整性检查
if (chartsData) {
    console.log('图表数据加载成功:', chartsData);
} else {
    console.error('图表数据未加载');
}

// 配置图表颜色
const colors = {
    status: {
        // 英文状态值
        'draft': '#6c757d',
        'submitted': '#17a2b8',
        'reviewing': '#ffc107',
        'approved': '#fd7e14',
        'in_development': '#007bff',
        'testing': '#20c997',
        'completed': '#28a745',
        'rejected': '#dc3545',
        'cancelled': '#343a40',
        'on_hold': '#6c757d',
        // 中文状态值
        '草稿': '#6c757d',
        '已提交': '#17a2b8',
        '待评审': '#ffc107',
        '评审中': '#ffc107',
        '已批准': '#fd7e14',
        'In progress': '#007bff',
        '测试中': '#20c997',
        'Completed': '#28a745',
        '已拒绝': '#dc3545',
        'Cancelled': '#343a40',
        'On Hold': '#6c757d'
    },
    priority: {
        // 英文优先级值（兼容旧数据）
        'critical': '#dc3545',
        'high': '#fd7e14',
        'medium': '#ffc107',
        'low': '#17a2b8',
        // 中文优先级值
        '关键': '#dc3545',
        '高': '#fd7e14',
        '中': '#ffc107',
        '低': '#17a2b8'
    },
    types: {
        // 中文类型值
        '功能需求': '#FF6384',
        '非功能需求': '#36A2EB',
        '业务需求': '#FFCE56',
        '用户需求': '#4BC0C0',
        '系统需求': '#9966FF',
        '接口需求': '#FF9F40',
        '性能需求': '#FF6384',
        '安全需求': '#C9CBCF'
    }
};

// 状态分布饼图
if (chartsData && chartsData.status_chart) {
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: chartsData.status_chart.labels,
            datasets: [{
                data: chartsData.status_chart.data,
                backgroundColor: chartsData.status_chart.labels.map(label => colors.status[label] || '#ccc')
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    console.log('状态图表创建成功');
}

// 优先级分布柱状图
if (chartsData && chartsData.priority_chart) {
    const priorityCtx = document.getElementById('priorityChart').getContext('2d');
    new Chart(priorityCtx, {
        type: 'bar',
        data: {
            labels: chartsData.priority_chart.labels,
            datasets: [{
                label: '需求数量',
                data: chartsData.priority_chart.data,
                backgroundColor: chartsData.priority_chart.labels.map(label => 
                    colors.priority[label] || '#ccc'
                )
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    console.log('优先级图表创建成功');
}

// 类型分布饼图
if (chartsData && chartsData.type_chart) {
    const typeCtx = document.getElementById('typeChart').getContext('2d');
    new Chart(typeCtx, {
        type: 'pie',
        data: {
            labels: chartsData.type_chart.labels,
            datasets: [{
                data: chartsData.type_chart.data,
                backgroundColor: chartsData.type_chart.labels.map(label => 
                    colors.types[label] || '#ccc'
                )
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    console.log('类型图表创建成功');
}

// 月度趋势线图
if (chartsData && chartsData.trend_chart) {
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: chartsData.trend_chart.labels,
            datasets: [{
                label: '新增需求',
                data: chartsData.trend_chart.created_data,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.1
            }, {
                label: '完成需求',
                data: chartsData.trend_chart.completed_data,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    console.log('月度趋势图表创建成功');
}

// 项目分布横向柱状图
if (chartsData && chartsData.project_chart) {
    const projectCtx = document.getElementById('projectChart').getContext('2d');
    new Chart(projectCtx, {
        type: 'bar',
        data: {
            labels: chartsData.project_chart.labels,
            datasets: [{
                label: '待处理',
                data: chartsData.project_chart.pending_data,
                backgroundColor: '#6c757d'
            }, {
                label: 'In Progress',
                data: chartsData.project_chart.in_progress_data,
                backgroundColor: '#007bff'
            }, {
                label: 'Completed',
                data: chartsData.project_chart.completed_data,
                backgroundColor: '#28a745'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                y: {
                    stacked: true
                }
            }
        }
    });
    console.log('项目分布图表创建成功');
}

// 项目筛选
function filterByProject(projectId) {
    window.location.href = '{{ url_for("requirement.statistics") }}?project_id=' + projectId;
}
</script>
{% endblock %}
