{% extends "base.html" %}

{% block title %}编辑用户 - 需求管理系统{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-user-edit"></i> 编辑用户：{{ user.username }}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="username" class="form-label">用户名 *</label>
                                    <input type="text" class="form-control" id="username" name="username" 
                                           value="{{ user.username }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email" class="form-label">邮箱 *</label>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           value="{{ user.email }}" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="full_name" class="form-label">姓名</label>
                                    <input type="text" class="form-control" id="full_name" name="full_name" 
                                           value="{{ user.full_name or '' }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="department" class="form-label">部门</label>
                                    <input type="text" class="form-control" id="department" name="department" 
                                           value="{{ user.department or '' }}">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="role" class="form-label">角色 *</label>
                                    <select class="form-select" id="role" name="role" required>
                                        <option value="viewer" {% if user.role == 'viewer' %}selected{% endif %}>查看者</option>
                                        <option value="developer" {% if user.role == 'developer' %}selected{% endif %}>开发人员</option>
                                        <option value="tester" {% if user.role == 'tester' %}selected{% endif %}>测试人员</option>
                                        <option value="manager" {% if user.role == 'manager' %}selected{% endif %}>项目经理</option>
                                        {% if current_user.role == 'admin' %}
                                        <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>管理员</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">账户状态</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active"
                                               {% if user.is_active %}checked{% endif %}
                                               {% if user.id == current_user.id %}disabled{% endif %}>
                                        <label class="form-check-label" for="is_active">
                                            启用账户
                                            {% if user.id == current_user.id %}
                                            <small class="text-muted">（不能禁用自己的账户）</small>
                                            {% endif %}
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label for="new_password" class="form-label">新密码</label>
                            <input type="password" class="form-control" id="new_password" name="new_password" 
                                   placeholder="留空则不修改密码">
                            <div class="form-text">密码至少8位，包含大小写字母、数字和特殊字符</div>
                        </div>

                        <hr>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">创建时间</label>
                                    <input type="text" class="form-control" 
                                           value="{{ user.created_at.strftime('%Y-%m-%d %H:%M:%S') }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">最后登录</label>
                                    <input type="text" class="form-control" 
                                           value="{% if user.last_login %}{{ user.last_login.strftime('%Y-%m-%d %H:%M:%S') }}{% else %}从未登录{% endif %}" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('auth.admin_users') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> 返回列表
                            </a>
                            <div>
                                {% if user.id != current_user.id and user.role != 'admin' %}
                                <button type="button" class="btn btn-danger me-2" 
                                        onclick="if(confirm('确定要删除用户 {{ user.username }} 吗？此操作不可撤销！')) { 
                                            var form = document.createElement('form'); 
                                            form.method = 'POST'; 
                                            form.action = '{{ url_for('auth.admin_delete_user', user_id=user.id) }}'; 
                                            var csrfInput = document.createElement('input'); 
                                            csrfInput.type = 'hidden'; 
                                            csrfInput.name = 'csrf_token'; 
                                            csrfInput.value = '{{ csrf_token() }}'; 
                                            form.appendChild(csrfInput); 
                                            document.body.appendChild(form); 
                                            form.submit(); 
                                        }">
                                    <i class="fas fa-trash"></i> 删除用户
                                </button>
                                {% endif %}
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> 保存更改
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}